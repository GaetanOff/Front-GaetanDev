<app-templadmin>
  <div class="flex-1 p-8">
    <h1 class="text-3xl font-bold mb-6 text-white">Proxy List</h1>
    <p class="text-gray-300 mb-4">
      Last refresh:
      @if (isLoading) {
        <span>loading...</span>
      }
      @if (!isLoading) {
        <span>{{ lastRefresh }}</span>
      }
    </p>
    <div class="flex space-x-4 mb-6">
      <button (click)="showServers = true" class="bg-green-400/80 hover:bg-green-400 text-black font-semibold px-4 py-2 rounded-xl transition-all duration-300 shadow-md hover:shadow-lg transform hover:-translate-y-1">
        Show Scanning Servers status
      </button>

      <button (click)="showProxy = true" class="bg-green-400/80 hover:bg-green-400 text-black font-semibold px-4 py-2 rounded-xl transition-all duration-300 shadow-md hover:shadow-lg transform hover:-translate-y-1">
        Open Proxy Checker
      </button>
    </div>

    @if (showServers) {
      <div class="fixed inset-0 flex items-center justify-center bg-black/50 backdrop-blur-sm z-50">
        <div class="bg-black/20 backdrop-blur-xl rounded-3xl shadow-2xl border border-white/20 p-6 w-11/12 md:w-2/3 lg:w-1/2">
          <div class="flex justify-between items-center border-b border-white/20 pb-2">
            <h2 class="text-2xl font-semibold text-white">Scanning Servers</h2>
            <button (click)="showServers = false" class="text-white hover:text-gray-200 text-2xl transition-colors">&times;</button>
          </div>
          <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
            @for (server of scanningServers; track server) {
              <div class="p-4 border border-white/20 rounded-xl shadow-sm bg-white/10 backdrop-blur-md cursor-pointer duration-300 hover:bg-white/20 hover:shadow-lg hover:shadow-green-600/30 text-white"
                (click)="navigateToDetails(server.id)">
                <div class="flex items-center justify-between">
                  <span class="text-lg font-bold">Server {{ server.id }}</span>
                  <span [ngClass]="{'text-green-400': server.status === 'online', 'text-red-400': server.status !== 'online'}" class="font-semibold">
                    {{ server.status }}
                  </span>
                </div>
                <div class="mt-2">
                  <p class="text-sm text-gray-200">CPU: <span class="font-medium">{{ server.cpu }}%</span></p>
                  <p class="text-sm text-gray-200">RAM: <span class="font-medium">{{ server.ram }}%</span></p>
                </div>
              </div>
            }
          </div>
          <div class="mt-4 flex justify-end">
            <button (click)="showServers = false" class="bg-green-400/80 hover:bg-green-400 text-black font-semibold px-4 py-2 rounded-xl transition-all duration-300">
              Close
            </button>
          </div>
        </div>
      </div>
    }

    <!-- Popup Proxy Checker -->
    @if (showProxy) {
      <div class="fixed inset-0 flex items-center justify-center bg-black/50 backdrop-blur-sm z-50">
        <div class="bg-black/20 backdrop-blur-xl rounded-3xl shadow-2xl border border-white/20 p-6 w-11/12 md:w-2/3 lg:w-1/2">
          <div class="flex justify-between items-center border-b border-white/20 pb-2">
            <h2 class="text-2xl font-semibold text-white">Proxy Checker</h2>
            <button (click)="closeProxyChecker()" class="text-white hover:text-gray-200 text-2xl transition-colors">&times;</button>
          </div>
          <div class="mt-4">
            <form (submit)="checkProxy($event)">
              <div class="mb-4">
                <label class="block text-sm font-semibold mb-1 text-white">Protocol</label>
                <select [(ngModel)]="proxyProtocol" name="protocol" style="color-scheme: dark;" class="w-full bg-white/10 backdrop-blur-md text-white p-3 rounded-xl border border-white/20 focus:outline-none focus:ring-2 focus:ring-green-400 appearance-none transition-all duration-300">
                  <option value="http">HTTP</option>
                  <option value="socks5">SOCKS5</option>
                </select>
              </div>
              <div class="mb-4">
                <label class="block text-sm font-semibold mb-1 text-white">Host</label>
                <input type="text" [(ngModel)]="proxyHost" name="host" placeholder="Proxy host" class="w-full bg-white/10 backdrop-blur-md text-white placeholder-gray-300 p-3 rounded-xl border border-white/20 focus:outline-none focus:ring-2 focus:ring-green-400 transition-all duration-300">
              </div>
              <div class="mb-4">
                <label class="block text-sm font-semibold mb-1 text-white">Port</label>
                <input type="number" [(ngModel)]="proxyPort" name="port" placeholder="Proxy port" class="w-full bg-white/10 backdrop-blur-md text-white placeholder-gray-300 p-3 rounded-xl border border-white/20 focus:outline-none focus:ring-2 focus:ring-green-400 transition-all duration-300">
              </div>
              <div class="mb-4">
                <label class="block text-sm font-semibold mb-1 text-white">Server</label>
                <select [(ngModel)]="serverToCheck" name="server" style="color-scheme: dark;" class="w-full bg-white/10 backdrop-blur-md text-white p-3 rounded-xl border border-white/20 focus:outline-none focus:ring-2 focus:ring-green-400 appearance-none transition-all duration-300">
                  <option value="random">Random</option>
                  @for (server of scanningServers; track server) {
                    <option [value]="server.id">
                      Server {{ server.id }} - CPU: {{ server.cpu }}%, RAM: {{ server.ram }}% ({{ server.status }})
                    </option>
                  }
                </select>
              </div>
              <div class="flex justify-end">
                @if (!isCheckerLoading) {
                  <button type="submit" class="bg-green-400/80 hover:bg-green-400 text-black font-semibold px-4 py-2 rounded-xl transition-all duration-300 shadow-md hover:shadow-lg transform hover:-translate-y-1">
                    Check Proxy
                  </button>
                }
                @if (isCheckerLoading) {
                  <div class="bg-green-400/80 text-black font-semibold px-4 py-2 rounded-xl">
                    Checking...
                  </div>
                }
              </div>
            </form>
            @if (proxyCheckResult) {
              <div class="mt-4 p-4 border border-white/20 rounded-xl bg-white/10 backdrop-blur-md">
                @if (proxyCheckResult.success) {
                  <p class="text-green-400">
                    Proxy is functional. Data: {{ proxyCheckResult.data | json }}
                  </p>
                }
                @if (!proxyCheckResult.success) {
                  <p class="text-red-400">
                    Proxy failed: {{ proxyCheckResult.error }}
                  </p>
                }
              </div>
            }
          </div>
        </div>
      </div>
    }

    <div class="flex flex-col md:flex-row justify-center md:justify-between">
      <div class="w-1/2 p-4">
        <h2 class="text-2xl font-bold mb-4 text-white">HTTP Proxies</h2>
        @if (!isLoading) {
          <div class="w-full bg-white/10 backdrop-blur-md text-white mt-2 p-3 rounded-xl border border-white/20 min-h-[120px] overflow-auto">
            <ul class="space-y-1">
              @for (proxy of httpProxies.slice(0, 15); track proxy) {
                <li class="font-mono text-sm">{{ proxy.host }}:{{ proxy.port }}</li>
              }
              <li class="italic pt-2 text-gray-300">... {{ httpProxies.length }} more</li>
            </ul>
          </div>
        }
        @if (isLoading) {
          <div>
            <app-refresh-proxies-whitelist></app-refresh-proxies-whitelist>
          </div>
        }
      </div>
      <div class="w-1/2 p-4">
        <h2 class="text-2xl font-bold mb-4 text-white">SOCKS5 Proxies</h2>
        @if (!isLoading) {
          <div class="w-full bg-white/10 backdrop-blur-md text-white mt-2 p-3 rounded-xl border border-white/20 min-h-[120px] overflow-auto">
            <ul class="space-y-1">
              @for (proxy of socks5Proxies.slice(0, 15); track proxy) {
                <li class="font-mono text-sm">{{ proxy.host }}:{{ proxy.port }}</li>
              }
              <li class="italic pt-2 text-gray-300">... {{ socks5Proxies.length }} more</li>
            </ul>
          </div>
        }
        @if (isLoading) {
          <div>
            <app-refresh-proxies-whitelist></app-refresh-proxies-whitelist>
          </div>
        }
      </div>
    </div>

    <div class="w-full p-4 mt-6 rounded-xl bg-white/10 backdrop-blur-md border border-white/20">
      <h2 class="text-2xl font-bold mb-4 text-white">Download Proxies with Filters</h2>
      <div class="flex flex-col md:flex-row gap-4">
        <div class="w-full md:w-1/3">
          <label class="block text-sm font-semibold mb-1 text-white">Select Country</label>
          @for (filter of countryFilters; track filter; let i = $index) {
            <div class="flex items-center gap-2 mb-2">
              <select [(ngModel)]="countryFilters[i]" (ngModelChange)="updateProxyLimit()"
                [name]="'countryFilter' + i"
                style="color-scheme: dark;"
                class="w-full bg-white/10 backdrop-blur-md text-white p-3 rounded-xl border border-white/20 focus:outline-none focus:ring-2 focus:ring-green-400 appearance-none transition-all duration-300">
                @if (countryFilters.length > 1) {
                  @for (country of filteredCountries; track country) {
                    <option [value]="country">{{ country }}</option>
                  }
                } @else {
                  @for (country of countries; track country) {
                    <option [value]="country">{{ country }}</option>
                  }
                }
              </select>
              @if (countryFilters.length > 1) {
                <button (click)="removeCountryFilter(i)"
                class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors">-</button>
              }
            </div>
          }
          @if (countryFilters[0] !== 'All') {
            <button (click)="addCountryFilter()"
              class="px-4 py-2 bg-green-400/80 hover:bg-green-400 text-black font-semibold rounded-xl transition-all duration-300">
              +
            </button>
          }
        </div>

        <div class="w-full md:w-1/3">
          <label class="block text-sm font-semibold mb-1 text-white">Proxy Type</label>
          <div class="relative">
            <select [(ngModel)]="selectedProxyType" (ngModelChange)="updateAvailableCountries()"
              name="selectedProxyType"
              style="color-scheme: dark;"
              class="w-full bg-white/10 backdrop-blur-md text-white p-3 rounded-xl border border-white/20 focus:outline-none focus:ring-2 focus:ring-green-400 appearance-none transition-all duration-300">
              <option value="http">HTTP</option>
              <option value="socks5">SOCKS5</option>
            </select>
            <div class="absolute inset-y-0 right-3 flex items-center pointer-events-none text-white">
              â–¼
            </div>
          </div>
        </div>

        <div class="w-full md:w-1/3">
          <label class="block text-sm font-semibold mb-1 text-white">Number of Proxy</label>
          <input type="number" [(ngModel)]="proxyLimit" name="proxyLimit" min="1" max="1000"
            class="w-full bg-white/10 backdrop-blur-md text-white placeholder-gray-300 p-3 rounded-xl border border-white/20 focus:outline-none focus:ring-2 focus:ring-green-400 transition-all duration-300" />
        </div>
      </div>

      <button (click)="downloadFilteredProxies()"
        class="px-4 py-2 mt-4 bg-green-400/80 hover:bg-green-400 text-black font-semibold rounded-xl w-full transition-all duration-300 shadow-md hover:shadow-lg transform hover:-translate-y-1">
        Download Filtered Proxies
      </button>
    </div>
  </div>
</app-templadmin>
